# 实验一 性能测试报告



## 1. 实验简介

​		多线程编程是高性能编程的技术之一，实验1将针对数独求解问题比较多线程与单线程的性能差异、同一功能不同代码实现的性能差异以及多线程在不同硬件环境下的性能差异。

### 1.1 程序输入

​		程序在控制台接收用户输入，该输入为一个数独谜题文件，该文件包含多个数独谜题，文件中的每一行为一道数独题每个数独谜题按固定格式存储在该文件中。

### 1.2 程序输出

​		程序将按照数独输入文件的顺序将每到数独答案打印到屏幕上。

### 1.3 Sudoku算法

​		实验共提供了4中不同的 Sudoku 求解算法：BASIC, DANCE, MINA和MINAC。实验中选用的是最快的 DANCE 算法。



### 1.4 性能指标

​		由于考虑到打印到屏幕的时间要远大于解题的时间，所以我们采用的性能指标是从文件输入到解决所有数独题的时间（不输出到屏幕）。一般而言，可以用加速比直观地表示并行程序与串行程序之间的性能差异（加速比：串行执行时间与并行执行时间的比率，是串行与并行执行时间之间一个具体的比较指标，**这里的串行执行时间我们使用的是原代码执行相同的文件所消耗的时间**）。



### 1.5 实验环境

​		实验中共有2个不同的实验环境：**ENV 1 ** 和  **ENV 2**。

​		**ENV 1:** linux 内核版本为 4.4.0-18362-Microsoft；16GB 内存；CPU 型号为 Intel(R) Core(TM) i7-8750H CPU @ 2.20GHz，共有  1个物理 CPU，有 6 个物理核心，使用超线程技术，具有 12 个逻辑核心。

​		**ENV 2:** linux 内核版本为 4.4.0-19041-Microsoft；16GB 内存；CPU 型号为 Intel(R) Core(TM) i5-8300H CPU @ 2.30GHz，共 1 个物理 CPU；有 4 个物理核心，使用超线程技术，具有 8 个逻辑核心。



### 1.6 代码实现版本

​		实验中共使用两份不同的代码：**Code1**和**Code2**。

​		**Code1:** 原生的数独求解代码，即本实验中所提供的代码，只能以单线程模式运行。

​		**Code2:** 采用多线程并行求解以充分利用CPU的核数。编写了一个函数获取CPU的核数n，然后创建n个线程以最大化利用CPU。利用了一系列的锁和条件变量控制缓冲区的访问、打印顺序、文件名的获取。一共有三种不同的线程：监控输入线程（负责读入键盘输入的文件名到文件队列），生产者线程（负责从文件中每次读取一行放到缓冲区，其实就是main函数），消费者线程（负责从缓冲区每次读取一行求解，然后打印到屏幕），前两者各一个，后者有n（CPU核数）个。



## 2. 性能测试

​		程序的性能会受到诸多因素的影响，其中包括软件层面的因素和硬件层面的因素。对于时间的测试我们采用的是多次测量求平均值的方法来保证时间相对可靠。

​		在测试的过程中，我们采用shell脚本完成自动测试，并且使用python进行完成绘图。我们将分析比较多线程程序与单线程程序的性能差异、同一个程序在不同硬件环境下的性能差异。



### 2.1 多线程与单线程性能比较

​		单线程程序只能利用 1 个 CPU 核心，而多线程程序能使 CPU 的多个核心并行运作，因此，多线程能够充分发挥多核 CPU 的优势。在一定范围内，加速比会随着线程数的增加而增长，即时间开销越少、效率越高。当线程数超过 CPU 核心数时，性能会有所下降。

​		为了比较多线程与单线程性能差异，实验将提供 1 个大小为 40040KB ，共有 50 万道数独题的文件，而后分别使用单个sudoku_solve 线程和 n 个 sudoku_solve 线程分别对该文件内的所有数独题进行求解，测量这一部分所需要的时间开销并计算加速比。

​		下图展示了不同线程数对性能造成的影响，其2条折线：**时间**和**加速比**分别表示随 sodoku_solve 线程数量的变化所需的时间开销和相应的加速比。

![运行时间及加速比](.\img\运行时间及加速比.jpg)

​		从上图可以看出，当总线程数小于 CPU 总核心数时，随着线程数的增加，所需要的时间开销越小、加速比更高。从sudoku_solve 线程数为 12 开始，总线程数超过 CPU 物理核心数，线程开始被操作系统调度，所以会有切换线程消耗的时间，同时调度会有一定的开销，所以性能会有所下降。当超过 12 之后，再增加线程数，消耗时间则趋于平稳，这是因为不同的 CPU 核心上切换线程是几乎同时发生的，所以不会有额外的时间开销。



### 2.2 不同硬件环境性能比较

​		硬件环境如 CPU 主频（其它如物理 CPU 个数、物理核心数等）的不同，会导致同一个程序在不同的硬件环境中有不同的表现。对单个 CPU 物理核心，其主频越高，运行速度越快。

​		实验将使用 Code2 分别在 ENV 1 和 ENV 2 中对大小为8008KB、具有100 K个数独题的文件进行求解，其中sudoku_solve 线程数从1开始逐步增加，测量时间开销。

​		下图为 Code2 在不同的硬件环境ENV 1和ENV 2中分别调整不同的 sudoku_solve 线程数的测试结果。

![不同环境对比](.\img\不同环境对比.jpg)

​		从上图可以看出，当sudoku_solve 线程数在 1～2 时，ENV 1 的时间与 ENV 2 的时间相差不大，因为 ENV 1 的 CPU 主频为 2.30 GHZ，与 ENV 1 的 CPU 主频 2.20 GHZ，即对单个物理核心而言，ENV 1 的运行速度与 ENV 1 相差不大。

​		当 sudoku_solve 线程数量在 3～8 时，ENV 2 的时间开销要略大于 ENV 1，由于ENV 1 的主频略大于 ENV 2，此时CPU主频差距开始显现，ENV 1 单个核心跑单个线程的速度快于ENV 2。

​		当 sudoku_solve 线程数量在 8～12 时，ENV 2 的时间开销开始明显大于 ENV 1，这是因为 ENV 2 总共只有 4 个物理核心，通过超线程技术模拟出 8 个逻辑核心，但 EVN 1 有 6 个物理核心通过超线程技术模拟出 12 个逻辑核心，所以当线程数超过8个后，EVN 2 会有线程调度的时间消耗，而 EVN 1则没有该消耗，所以时间差距开始变得明显。

​		继续增加 sudoku_solve 线程数量后，两个环境的消耗时间差距变得平稳，这是因为当线程数超过 12 后 ENV 1 也会产生线程调度的时间消耗，所以超过 12 个线程后，两个环境的消耗时间差距趋近平稳。

